{% extends "layout.html" %}
{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Mesa de DecisiÃ³n</h1>
        <p class="page-desc">Cada decisiÃ³n entrena al algoritmo v3.0.</p>
    </div>
    <div class="badge warning" style="font-size: 1rem; padding: 0.5rem 1rem;">
        Pendientes: {{ logs|length }}
    </div>
</div>

{% if logs %}
<div class="card-grid">
    {% for log in logs %}
    <section class="panel-card log-card">

        <!-- HEADER TARJETA -->
        <header class="card-header">
            <div class="meta-row">
                <span class="log-timestamp">{{ log.fecha_hora }}</span>
                <span class="log-operator">{{ log.operador.split('@')[0] }}</span>
                <span class="log-linea">{{ log.linea }}</span>
            </div>
            <div class="verdict-row">
                {% if log.resultado_sistema == 'CORRECTO' %}
                <span class="badge correct large">âœ… CORRECTO</span>
                {% elif log.resultado_sistema == 'INCORRECTO' %}
                <span class="badge danger large">ðŸ”´ INCORRECTO</span>
                {% else %}
                <span class="badge warning large">ðŸŸ¡ OBSERVACIÃ“N</span>
                {% endif %}

                {% if log.regla_sistema %}
                <span class="rule-tag">Regla: {{ log.regla_sistema }}</span>
                {% endif %}
            </div>
        </header>

        <!-- CUERPO PRINCIPAL (GRID 2 COLUMNAS) -->
        <div class="card-body-grid">

            <!-- COLUMNA IZQUIERDA: MENSAJE ORIGINAL -->
            <div class="original-column">
                <h4 class="column-title">Mensaje Original</h4>
                <div class="message-box">
                    <code>{{ log.texto }}</code>
                </div>
            </div>

            <!-- COLUMNA DERECHA: HALLAZGOS Y RECOMENDACION -->
            <div class="analysis-column">
                <h4 class="column-title">Hallazgos del Sistema</h4>
                <div class="findings-box">
                    {% if log.detalle_sistema %}
                    {% for item in log.detalle_sistema.split('|') %}
                    <div class="finding-item">â€¢ {{ item.strip() }}</div>
                    {% endfor %}
                    {% else %}
                    <div class="finding-item">Sin observaciones. Cumple estÃ¡ndar.</div>
                    {% endif %}
                </div>

                {% if log.resultado_sistema != 'CORRECTO' %}
                <h4 class="column-title mt-4">Ejemplo Recomendado</h4>
                <div class="recommendation-box">
                    <!-- TODO: Generar ejemplo dinÃ¡mico en backend -->
                    <code>XX.X.X - EL TREN [NRO] DE LAS [HH:MM] HS PARTIENDO DE [ORIGEN] HACIA [DESTINO] CIRCULA CON DEMORAS DE [XX] MINUTOS POR [CAUSA].</code>
                </div>
                {% endif %}
            </div>

        </div>

        <!-- FOOTER: ACCIONES -->
        <footer class="card-footer">
            <form action="{{ url_for('panel_auditoria_decision') }}" method="POST" class="actions-form">
                <input type="hidden" name="msg_id" value="{{ log.id }}">

                <!-- ACCION PRINCIPAL -->
                <button type="submit" name="accion" value="CONFIRMAR" class="btn btn-primary btn-lg btn-block">
                    âœ… Confirmar Dictamen
                </button>

                <!-- ZONA DE CORRECCIONES (COLLAPSIBLE O SEPARADO) -->
                </hr>
                <!-- ZONA DE CORRECCIONES (HIDDEN BY DEFAULT) -->
                </hr>
                <div class="system-correction-zone" id="zone-{{ log.id }}">
                    <!-- State 1: Buttons -->
                    <div class="correction-initial" id="initial-{{ log.id }}">
                        <span class="correction-label">âš  Â¿El sistema se equivocÃ³?</span>
                        <button type="button" onclick="showCorrection('{{ log.id }}', 'FALSO_POSITIVO')"
                            class="btn btn-sm btn-ghost">FP: MarcÃ³ Mal</button>
                        <button type="button" onclick="showCorrection('{{ log.id }}', 'FALSO_NEGATIVO')"
                            class="btn btn-sm btn-ghost">FN: No DetectÃ³</button>
                    </div>

                    <!-- State 2: Note Input -->
                    <div class="correction-form" id="form-{{ log.id }}" style="display:none; width: 100%;">
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:0.5rem;">
                            <strong id="label-{{ log.id }}"
                                style="color:var(--danger-text); font-size:0.8rem;"></strong>
                            <button type="button" onclick="cancelCorrection('{{ log.id }}')"
                                style="font-size:0.8rem; border:none; background:none; cursor:pointer;">(Cancelar)</button>
                        </div>
                        <textarea name="nota_temp" id="note-{{ log.id }}" class="form-control"
                            placeholder="Describa el error del sistema (Obligatorio)..." rows="2"
                            style="width:100%; margin-bottom:0.5rem;"></textarea>
                        <!-- Hidden inputs to carry values to the main form -->
                        <button type="button" onclick="submitCorrection('{{ log.id }}')"
                            class="btn btn-danger btn-sm btn-block">Registrar Error y Archivar</button>
                    </div>
                </div>

                <!-- Hidden fields for JS handling -->
                <input type="hidden" name="nota" id="final-note-{{ log.id }}">
            </form>
        </footer>

    </section>
    {% endfor %}
</div>

<script>
    function showCorrection(id, type) {
        document.getElementById('initial-' + id).style.display = 'none';
        document.getElementById('form-' + id).style.display = 'block';

        // Set the button value for the main form submission later? 
        // Actually, we can't easily change the clicked button value in a standard form submit without JS intervention.
        // Let's store the intended action in a data attribute or hidden field if we were using AJAX.
        // For standard form, we need to inject the action into the form when submitting.

        const label = type === 'FALSO_POSITIVO' ? 'Reportando Falso Positivo (FP)' : 'Reportando Falso Negativo (FN)';
        document.getElementById('label-' + id).innerText = label;
        document.getElementById('note-' + id).dataset.action = type;
        document.getElementById('note-' + id).focus();
    }

    function cancelCorrection(id) {
        document.getElementById('form-' + id).style.display = 'none';
        document.getElementById('initial-' + id).style.display = 'flex';
        document.getElementById('note-' + id).value = '';
    }

    function submitCorrection(id) {
        const noteField = document.getElementById('note-' + id);
        const note = noteField.value.trim();
        const action = noteField.dataset.action;

        if (note.length < 5) {
            alert("Por favor, agregue una nota explicativa del error (mÃ­nimo 5 caracteres).");
            return;
        }

        // Populate hidden fields
        document.getElementById('final-note-' + id).value = note;

        // Create a hidden input for the action because we are submitting via JS
        const form = noteField.closest('form');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'accion';
        input.value = action;
        form.appendChild(input);

        form.submit();
    }
</script>
{% else %}
{% else %}
<!-- EMPTY STATE -->
<div class="empty-state">
    <div class="empty-icon">ðŸŽ‰</div>
    <h3>Â¡Bandeja Limpia!</h3>
    <p>No hay mensajes pendientes de auditorÃ­a.</p>
</div>
{% endif %}
{% endblock %}